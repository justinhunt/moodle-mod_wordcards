{"version":3,"file":"listenchoose.min.js","sources":["../src/listenchoose.js"],"sourcesContent":["/**\r\n * Matching module.\r\n *\r\n * @package mod_wordcards\r\n * @author  Justin Hunt - poodll.com\r\n * * (based on Paul Raine's APPs 4 EFL)\r\n */\r\n\r\ndefine([\r\n  'jquery',\r\n  'core/ajax',\r\n  'core/log',\r\n  'mod_wordcards/a4e',\r\n  'mod_wordcards/pollyhelper',\r\n  'core/templates'\r\n], function($, Ajax, log, a4e, polly, templates) {\r\n\r\n  var app = {\r\n    dryRun: false,\r\n    audio: false,\r\n    ttslanguage: 'en-US',\r\n\r\n    init: function(props) {\r\n\r\n      //pick up opts from html\r\n      var theid = '#' + props.widgetid;\r\n      this.dryRun = props.dryRun;\r\n      this.nexturl = props.nexturl;\r\n      this.modid = props.modid;\r\n      this.lcoptions=props.lcoptions;\r\n      this.isFreeMode = props.isfreemode;\r\n      var configcontrol = $(theid).get(0);\r\n      if (configcontrol) {\r\n        var matchingdata = JSON.parse(configcontrol.value);\r\n        $(theid).remove();\r\n      } else {\r\n        //if there is no config we might as well give up\r\n        log.debug('No config found on page. Giving up.');\r\n        return;\r\n      }\r\n\r\n      app.process(matchingdata);\r\n\r\n      a4e.register_events();\r\n      a4e.init_audio(props.token,props.region,props.owner, props.cloudpoodllurl);\r\n      polly.init(props.token, props.region, props.owner, props.cloudpoodllurl);\r\n      app.ttslanguage = props.ttslanguage;\r\n\r\n      this.register_events();\r\n    },\r\n\r\n    register_events: function() {\r\n\r\n      // Get the audio element\r\n      var aplayer = $(\"#dictation_player\");\r\n      $(\"#listen-button\").click(function() {\r\n          if (app.audio) {\r\n              aplayer.attr('src', app.audio);\r\n              aplayer[0].play();\r\n          } else {\r\n              polly.fetch_polly_url(app.tts, 'text', app.ttsvoice);\r\n          }\r\n\r\n      });\r\n\r\n      //play what was returned in polly.fetch_polly_url\r\n      polly.onnewpollyurl = function(theurl) {\r\n          aplayer.attr('src', theurl);\r\n          aplayer[0].play();\r\n      };\r\n\r\n      $('body').on('click', \"#wordcards-close-results\", function() {\r\n\r\n        var total_time = app.timer.count;\r\n        var url = app.nexturl.replace(/&amp;/g, '&') + \"&localscattertime=\" + total_time\r\n        window.location.replace(url);\r\n\r\n      });\r\n\r\n      $('body').on('click', \"#wordcards-try-again\", function() {\r\n        location.reload();\r\n      });\r\n\r\n      $(\"body\").on('click', '.a4e-distractor', function(e) {\r\n        app.check($(this).data('correct'), this);\r\n      });\r\n\r\n      $('body').on('click', '#wordcards-start-button', function() {\r\n        app.start();\r\n      });\r\n\r\n    },\r\n\r\n    process: function(json) {\r\n      app.terms = json.terms;\r\n      a4e.list_vocab(\"#vocab-list-inner\", app.terms);\r\n    },\r\n    start: function() {\r\n      app.results = [];\r\n      a4e.shuffle(app.terms);\r\n      app.pointer = 0;\r\n      $(\"#wordcards-vocab-list, #wordcards-start-button\").hide();\r\n      $(\"#wordcards-gameboard\").show();\r\n      $(\"#wordcards-time-counter\").text(\"00:00\");\r\n      app.timer = {\r\n        interval: setInterval(function() {\r\n          app.timer.update();\r\n        }, 1000),\r\n        count: 0,\r\n        update: function() {\r\n          app.timer.count++;\r\n          $(\"#wordcards-time-counter\").text(a4e.pretty_print_secs(app.timer.count));\r\n        }\r\n      }\r\n      app.next();\r\n    },\r\n    quit: function() {\r\n      clearInterval(app.timer.interval);\r\n      $(\"#wordcards-gameboard\").hide();\r\n      $(\"#wordcards-vocab-list, #wordcards-start-button\").show();\r\n    },\r\n\r\n    end: function() {\r\n      clearInterval(app.timer.interval);\r\n      $(\"#wordcards-gameboard, #wordcards-start-button\").hide();\r\n      $(\"#wordcards-results\").show();\r\n\r\n      //template data\r\n      var tdata = [];\r\n      tdata['nexturl'] = this.nexturl;\r\n      tdata['results'] = app.results;\r\n      tdata['total'] = app.terms.length;\r\n      tdata['totalcorrect'] = a4e.calc_total_points(app.results);\r\n      var total_time = app.timer.count;\r\n      if (total_time == 0) {\r\n        tdata['prettytime'] = '00:00';\r\n      } else {\r\n        tdata['prettytime'] = a4e.pretty_print_secs(total_time);\r\n      }\r\n      templates.render('mod_wordcards/feedback', tdata).then(\r\n        function(html, js) {\r\n          $(\"#results-inner\").html(html);\r\n          // Add listeners for the \"Add to my words\" buttons.\r\n          require([\"mod_wordcards/mywords\"], function(mywords) {\r\n            mywords.initFromFeedbackPage();\r\n          });\r\n        }\r\n      );\r\n\r\n      var data = {\r\n        results: app.results,\r\n        activity: \"match_select\"\r\n      };\r\n\r\n      console.log(data);\r\n\r\n      if (!app.isFreeMode) {\r\n        Ajax.call([{\r\n          methodname: 'mod_wordcards_report_step_grade',\r\n          args: {\r\n            modid: app.modid,\r\n            correct: tdata['totalcorrect']\r\n          }\r\n        }]);\r\n      }\r\n\r\n\r\n    },\r\n    next: function() {\r\n      \r\n      a4e.progress_dots(app.results, app.terms);\r\n\r\n        app.tts = app.terms[app.pointer]['term'];\r\n\r\n        if (app.terms[app.pointer]['ttsvoice']) {\r\n            app.ttsvoice = app.terms[app.pointer]['ttsvoice'];\r\n        } else {\r\n            app.ttsvoice = 'auto';\r\n        }\r\n\r\n        if (app.terms[app.pointer]['audio']) {\r\n            app.audio = app.terms[app.pointer]['audio'];\r\n        } else {\r\n            app.audio = false;\r\n        }\r\n        $(\"#listen-button\").trigger(\"click\");\r\n\r\n      $(\"#wordcards-input\").html(app.get_distractors());\r\n\r\n    },\r\n\r\n    check: function(correct, clicked) {\r\n      var points = 0;\r\n      if (correct == true) {\r\n        //createjs.Sound.play('correct');\r\n        points = 1;\r\n      } else {\r\n        //createjs.Sound.play('incorrect');\r\n      }\r\n      $(\".a4e-distractor\").css('pointer-events', 'none');\r\n      \r\n      var result = {\r\n        question: app.terms[app.pointer]['definition'],\r\n        selected: $(clicked).text(),\r\n        correct: app.terms[app.pointer]['term'],\r\n        points: points,\r\n        id: app.terms[app.pointer]['id']\r\n      };\r\n      \r\n      app.results.push(result);\r\n\r\n      var background = correct == true ? 'a4e-correct' : 'a4e-incorrect';\r\n      $(clicked).addClass(background).append(\"<i style='color:\" + (correct ? 'green' : 'red') + \";margin-left:5px;' class='fa fa-\" + (correct ? 'check' : 'times') + \"'></i>\").parent().addClass('a4e-click-disabled');\r\n\r\n      if (!correct) {\r\n        $(\".a4e-distractor[data-correct='true']\").addClass('a4e-correct').append(\"<i style='color:green;margin-left:5px;' class='fa fa-check'></i>\");\r\n      }\r\n\r\n      //post results to server\r\n      if (correct) {\r\n        this.reportSuccess(app.terms[app.pointer]['id']);\r\n      } else {\r\n        this.reportFailure(app.terms[app.pointer]['id'], $(clicked).data('id'));\r\n      }\r\n\r\n      app.pointer++;\r\n      if (!correct) {\r\n        setTimeout(function() {\r\n          if (app.pointer < app.terms.length) {\r\n            app.next();\r\n          } else {\r\n            app.end();\r\n          }\r\n        }, 1500)\r\n      } else {\r\n        setTimeout(function() {\r\n          if (app.pointer < app.terms.length) {\r\n            app.next();\r\n          } else {\r\n            app.end();\r\n          }\r\n        }, 1000)\r\n      }\r\n    },\r\n\r\n    get_distractors: function() {\r\n      var distractors = app.terms.slice(0);\r\n      var answer = app.terms[app.pointer]['term'];\r\n      distractors.splice(app.pointer, 1);\r\n      a4e.shuffle(distractors);\r\n      distractors = distractors.slice(0, 4);\r\n      distractors.push(app.terms[app.pointer]);\r\n      a4e.shuffle(distractors);\r\n      var options = [];\r\n      $.each(distractors, function(i, o) {\r\n        var is_correct = o['term'] == answer;\r\n        var term_id = o['id'];\r\n        //depending on options  show option label as term or def\r\n        if(app.lcoptions===\"0\"){\r\n          var label= o['term'];\r\n        }else{\r\n         var label= o['definition'];\r\n        }\r\n        //\r\n        options.push('<li data-id=\"' + term_id + '\" data-correct=\"' + is_correct.toString() + '\" class=\"list-group-item a4e-distractor a4e-noselect\">' + label + '</li>');\r\n      });\r\n      var code = '<ul class=\"list-group a4e-distractors\">' + options.join('') + '</ul>';\r\n      return code;\r\n    },\r\n\r\n    reportFailure: function(term1id, term2id) {\r\n      if (this.dryRun) {\r\n        return;\r\n      }\r\n\r\n      Ajax.call([{\r\n        methodname: 'mod_wordcards_report_failed_association',\r\n        args: {\r\n          term1id: term1id,\r\n          term2id: term2id,\r\n          isfreemode: app.isFreeMode\r\n        }\r\n      }]);\r\n    },\r\n\r\n    reportSuccess: function(termid) {\r\n      if (this.dryRun) {\r\n        return;\r\n      }\r\n\r\n      Ajax.call([{\r\n        methodname: 'mod_wordcards_report_successful_association',\r\n        args: {\r\n          termid: termid,\r\n          isfreemode: app.isFreeMode\r\n        }\r\n      }]);\r\n    }\r\n  };\r\n\r\n  return app;\r\n\r\n});"],"names":["define","$","Ajax","log","a4e","polly","templates","app","dryRun","audio","ttslanguage","init","props","theid","widgetid","nexturl","modid","lcoptions","isFreeMode","isfreemode","configcontrol","get","matchingdata","JSON","parse","value","remove","process","register_events","init_audio","token","region","owner","cloudpoodllurl","debug","aplayer","click","attr","play","fetch_polly_url","tts","ttsvoice","onnewpollyurl","theurl","on","total_time","timer","count","url","replace","window","location","reload","e","check","this","data","start","json","terms","list_vocab","results","shuffle","pointer","hide","show","text","interval","setInterval","update","pretty_print_secs","next","quit","clearInterval","end","tdata","length","calc_total_points","render","then","html","js","require","mywords","initFromFeedbackPage","activity","console","call","methodname","args","correct","progress_dots","trigger","get_distractors","clicked","points","css","result","question","selected","id","push","background","addClass","append","parent","reportSuccess","reportFailure","setTimeout","distractors","slice","answer","splice","options","each","i","o","is_correct","term_id","label","toString","join","term1id","term2id","termid"],"mappings":"AAQAA,oCAAO,CACL,SACA,YACA,WACA,oBACA,4BACA,mBACC,SAASC,EAAGC,KAAMC,IAAKC,IAAKC,MAAOC,eAEhCC,IAAM,CACRC,QAAQ,EACRC,OAAO,EACPC,YAAa,QAEbC,KAAM,SAASC,WAGTC,MAAQ,IAAMD,MAAME,cACnBN,OAASI,MAAMJ,YACfO,QAAUH,MAAMG,aAChBC,MAAQJ,MAAMI,WACdC,UAAUL,MAAMK,eAChBC,WAAaN,MAAMO,eACpBC,cAAgBnB,EAAEY,OAAOQ,IAAI,MAC7BD,mBACEE,aAAeC,KAAKC,MAAMJ,cAAcK,OAC5CxB,EAAEY,OAAOa,SAOXnB,IAAIoB,QAAQL,cAEZlB,IAAIwB,kBACJxB,IAAIyB,WAAWjB,MAAMkB,MAAMlB,MAAMmB,OAAOnB,MAAMoB,MAAOpB,MAAMqB,gBAC3D5B,MAAMM,KAAKC,MAAMkB,MAAOlB,MAAMmB,OAAQnB,MAAMoB,MAAOpB,MAAMqB,gBACzD1B,IAAIG,YAAcE,MAAMF,iBAEnBkB,uBAXHzB,IAAI+B,MAAM,wCAcdN,gBAAiB,eAGXO,QAAUlC,EAAE,qBAChBA,EAAE,kBAAkBmC,OAAM,WAClB7B,IAAIE,OACJ0B,QAAQE,KAAK,MAAO9B,IAAIE,OACxB0B,QAAQ,GAAGG,QAEXjC,MAAMkC,gBAAgBhC,IAAIiC,IAAK,OAAQjC,IAAIkC,aAMnDpC,MAAMqC,cAAgB,SAASC,QAC3BR,QAAQE,KAAK,MAAOM,QACpBR,QAAQ,GAAGG,QAGfrC,EAAE,QAAQ2C,GAAG,QAAS,4BAA4B,eAE5CC,WAAatC,IAAIuC,MAAMC,MACvBC,IAAMzC,IAAIQ,QAAQkC,QAAQ,SAAU,KAAO,qBAAuBJ,WACtEK,OAAOC,SAASF,QAAQD,QAI1B/C,EAAE,QAAQ2C,GAAG,QAAS,wBAAwB,WAC5CO,SAASC,YAGXnD,EAAE,QAAQ2C,GAAG,QAAS,mBAAmB,SAASS,GAChD9C,IAAI+C,MAAMrD,EAAEsD,MAAMC,KAAK,WAAYD,SAGrCtD,EAAE,QAAQ2C,GAAG,QAAS,2BAA2B,WAC/CrC,IAAIkD,YAKR9B,QAAS,SAAS+B,MAChBnD,IAAIoD,MAAQD,KAAKC,MACjBvD,IAAIwD,WAAW,oBAAqBrD,IAAIoD,QAE1CF,MAAO,WACLlD,IAAIsD,QAAU,GACdzD,IAAI0D,QAAQvD,IAAIoD,OAChBpD,IAAIwD,QAAU,EACd9D,EAAE,kDAAkD+D,OACpD/D,EAAE,wBAAwBgE,OAC1BhE,EAAE,2BAA2BiE,KAAK,SAClC3D,IAAIuC,MAAQ,CACVqB,SAAUC,aAAY,WACpB7D,IAAIuC,MAAMuB,WACT,KACHtB,MAAO,EACPsB,OAAQ,WACN9D,IAAIuC,MAAMC,QACV9C,EAAE,2BAA2BiE,KAAK9D,IAAIkE,kBAAkB/D,IAAIuC,MAAMC,UAGtExC,IAAIgE,QAENC,KAAM,WACJC,cAAclE,IAAIuC,MAAMqB,UACxBlE,EAAE,wBAAwB+D,OAC1B/D,EAAE,kDAAkDgE,QAGtDS,IAAK,WACHD,cAAclE,IAAIuC,MAAMqB,UACxBlE,EAAE,iDAAiD+D,OACnD/D,EAAE,sBAAsBgE,WAGpBU,MAAQ,GACZA,MAAK,QAAcpB,KAAKxC,QACxB4D,MAAK,QAAcpE,IAAIsD,QACvBc,MAAK,MAAYpE,IAAIoD,MAAMiB,OAC3BD,MAAK,aAAmBvE,IAAIyE,kBAAkBtE,IAAIsD,aAC9ChB,WAAatC,IAAIuC,MAAMC,MAEzB4B,MAAK,WADW,GAAd9B,WACoB,QAEAzC,IAAIkE,kBAAkBzB,YAE9CvC,UAAUwE,OAAO,yBAA0BH,OAAOI,MAChD,SAASC,KAAMC,IACbhF,EAAE,kBAAkB+E,KAAKA,MAEzBE,QAAQ,CAAC,0BAA0B,SAASC,SAC1CA,QAAQC,iCAKV5B,KAAO,CACTK,QAAStD,IAAIsD,QACbwB,SAAU,gBAGZC,QAAQnF,IAAIqD,MAEPjD,IAAIW,YACPhB,KAAKqF,KAAK,CAAC,CACTC,WAAY,kCACZC,KAAM,CACJzE,MAAOT,IAAIS,MACX0E,QAASf,MAAK,kBAOtBJ,KAAM,WAEJnE,IAAIuF,cAAcpF,IAAIsD,QAAStD,IAAIoD,OAEjCpD,IAAIiC,IAAMjC,IAAIoD,MAAMpD,IAAIwD,SAAd,KAENxD,IAAIoD,MAAMpD,IAAIwD,SAAd,SACAxD,IAAIkC,SAAWlC,IAAIoD,MAAMpD,IAAIwD,SAAd,SAEfxD,IAAIkC,SAAW,OAGflC,IAAIoD,MAAMpD,IAAIwD,SAAd,MACAxD,IAAIE,MAAQF,IAAIoD,MAAMpD,IAAIwD,SAAd,MAEZxD,IAAIE,OAAQ,EAEhBR,EAAE,kBAAkB2F,QAAQ,SAE9B3F,EAAE,oBAAoB+E,KAAKzE,IAAIsF,oBAIjCvC,MAAO,SAASoC,QAASI,aACnBC,OAAS,EACE,GAAXL,UAEFK,OAAS,GAIX9F,EAAE,mBAAmB+F,IAAI,iBAAkB,YAEvCC,OAAS,CACXC,SAAU3F,IAAIoD,MAAMpD,IAAIwD,SAAd,WACVoC,SAAUlG,EAAE6F,SAAS5B,OACrBwB,QAASnF,IAAIoD,MAAMpD,IAAIwD,SAAd,KACTgC,OAAQA,OACRK,GAAI7F,IAAIoD,MAAMpD,IAAIwD,SAAd,IAGNxD,IAAIsD,QAAQwC,KAAKJ,YAEbK,WAAwB,GAAXZ,QAAkB,cAAgB,gBACnDzF,EAAE6F,SAASS,SAASD,YAAYE,OAAO,oBAAsBd,QAAU,QAAU,OAAS,oCAAsCA,QAAU,QAAU,SAAW,UAAUe,SAASF,SAAS,sBAEtLb,SACHzF,EAAE,wCAAwCsG,SAAS,eAAeC,OAAO,oEAIvEd,aACGgB,cAAcnG,IAAIoD,MAAMpD,IAAIwD,SAAd,SAEd4C,cAAcpG,IAAIoD,MAAMpD,IAAIwD,SAAd,GAA8B9D,EAAE6F,SAAStC,KAAK,OAGnEjD,IAAIwD,UACC2B,QASHkB,YAAW,WACLrG,IAAIwD,QAAUxD,IAAIoD,MAAMiB,OAC1BrE,IAAIgE,OAEJhE,IAAImE,QAEL,KAdHkC,YAAW,WACLrG,IAAIwD,QAAUxD,IAAIoD,MAAMiB,OAC1BrE,IAAIgE,OAEJhE,IAAImE,QAEL,OAYPmB,gBAAiB,eACXgB,YAActG,IAAIoD,MAAMmD,MAAM,GAC9BC,OAASxG,IAAIoD,MAAMpD,IAAIwD,SAAd,KACb8C,YAAYG,OAAOzG,IAAIwD,QAAS,GAChC3D,IAAI0D,QAAQ+C,cACZA,YAAcA,YAAYC,MAAM,EAAG,IACvBT,KAAK9F,IAAIoD,MAAMpD,IAAIwD,UAC/B3D,IAAI0D,QAAQ+C,iBACRI,QAAU,UACdhH,EAAEiH,KAAKL,aAAa,SAASM,EAAGC,OAC1BC,WAAaD,EAAC,MAAYL,OAC1BO,QAAUF,EAAC,MAEI,MAAhB7G,IAAIU,cACDsG,MAAOH,EAAC,UAETG,MAAOH,EAAC,WAGbH,QAAQZ,KAAK,gBAAkBiB,QAAU,mBAAqBD,WAAWG,WAAa,yDAA2DD,MAAQ,YAEhJ,0CAA4CN,QAAQQ,KAAK,IAAM,SAI5Ed,cAAe,SAASe,QAASC,SAC3BpE,KAAK/C,QAITN,KAAKqF,KAAK,CAAC,CACTC,WAAY,0CACZC,KAAM,CACJiC,QAASA,QACTC,QAASA,QACTxG,WAAYZ,IAAIW,gBAKtBwF,cAAe,SAASkB,QAClBrE,KAAK/C,QAITN,KAAKqF,KAAK,CAAC,CACTC,WAAY,8CACZC,KAAM,CACJmC,OAAQA,OACRzG,WAAYZ,IAAIW,wBAMjBX"}
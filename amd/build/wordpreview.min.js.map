{"version":3,"file":"wordpreview.min.js","sources":["../src/wordpreview.js"],"sourcesContent":["/**\n * Word Preview Module\n *\n * @package mod_wordcards\n * @author  Justin Hunt - poodll.com\n * *\n */\n\ndefine([\n  'jquery',\n  'core/ajax',\n  'core/log',\n  'core/str',\n  'mod_wordcards/a4e',\n  'mod_wordcards/textfit',\n  'core/templates',\n  'core/notification'\n], function($, Ajax, log, str, a4e, textFit, templates, notification) {\n\n  var app = {\n    dryRun: false,\n    termAtTop: \"0\",\n    strings: {},\n    nexturl: '',\n\n    init: function(props) {\n\n      //pick up opts from html\n      var theid = '#' + props.widgetid;\n      this.dryRun = props.dryRun;\n      this.nexturl = props.nexturl;\n      this.modid = props.modid;\n      this.msoptions=props.msoptions;\n      this.isFreeMode = props.isfreemode;\n      var configcontrol = $(theid).get(0);\n      if (configcontrol) {\n        var appdata = JSON.parse(configcontrol.value);\n        $(theid).remove();\n      } else {\n        //if there is no config we might as well give up\n        log.debug('No config found on page. Giving up.');\n        return;\n      }\n\n      //init strings\n      this.init_strings();\n\n      //set next url\n      if(app.nexturl === '') {\n        var currentUrl = new URL(window.location.href);\n        currentUrl.searchParams.delete('practicetype');\n        app.nexturl = currentUrl.toString();\n      }\n      log.debug(\"Next URL: \" + app.nexturl);\n\n      app.process(appdata);\n\n      a4e.register_events();\n      a4e.init_audio(props.token, props.region, props.owner, props.cloudpoodllurl);\n\n      this.register_events();\n    },\n\n    init_strings: function(){\n        // set up strings\n        str.get_strings([\n            {\"key\": \"nowordsselected\", \"component\": 'mod_wordcards'},\n            {\"key\": \"selectedwordstest\", \"component\": 'mod_wordcards'},\n            {\"key\": \"continue\", \"component\": 'core'},\n        ]).done(function(s) {\n            var i = 0;\n            app.strings.nowordsselected = s[i++];\n            app.strings.selectedwordstest = s[i++];\n            app.strings.continue = s[i++];\n        });\n    },\n\n    register_events: function() {\n\n      $('body').on('click', \"#wordcards-close-results\", function(e) {\n        e.preventDefault();\n        var total_time = app.timer.count;\n        log.debug(\"app.nexturl\" + app.nexturl);\n        var url = app.nexturl.replace(/&amp;/g, '&') + \"&localscattertime=\" + total_time\n        window.location.replace(url);\n      });\n\n      $('body').on('click', \"#wordcards-try-again\", function() {\n        location.reload();\n      });\n\n      $(\"body\").on('click', '.a4e-distractor', function(e) {\n        app.check($(this).data('correct'), this);\n      });\n\n      $('body').on('click', '#wordcards-start-button', function(e) {\n        e.preventDefault();\n        //collect terms that were selected\n        var selectedcheckboxes = $(\"#selfselect-inner .wc_selfselector\").find('input:checked');\n        app.selectedterms= [];\n        for (var i = 0; i < selectedcheckboxes.length; i++) {\n          var termid = $(selectedcheckboxes[i]).data('termid');\n          // If its already learned, we do not need to test it.\n          // We only test the self selected ones (and  not ye learned ones)\n          var learned = $(selectedcheckboxes[i]).data('learned');\n          if(learned==1 || learned=='true'){\n            continue;\n          }\n          // Push the term into the selected terms array\n          var term = app.terms.filter(function(t) {\n            return t.id == termid;\n          })[0];\n          app.selectedterms.push(term);\n        }\n        log.debug(\"Next URL confirm: \" + app.nexturl);\n        //if some words are selected start test. If not confirm and redirect\n        if(app.selectedterms.length === 0){\n          notification.confirm(app.strings.continue, \n            app.strings.nowordsselected,\n            app.strings.continue,'',\n            function(){\n              // In order to set the state for the current step complete\n              // We need at least one successful association.\n              // Though its not ideal we pass one in.\n              var aterm = app.terms[0];\n              app.reportSuccess(aterm.id);\n\n              //Then we set the next url and go\n              var theurl = app.nexturl.replace(/&amp;/g, '&');\n              window.location.href=theurl;\n            });\n          return;\n        }else{\n          notification.confirm(app.strings.continue, \n            app.strings.selectedwordstest,\n            app.strings.continue,'',\n            app.start);\n          return;\n        }\n        \n      });\n\n    },\n\n    process: function(appdata) {\n\n      app.terms = appdata.terms;\n      a4e.list_selfselect(\"#selfselect-inner\", appdata.terms);\n\n    },\n    start: function() {\n      app.results = [];\n      a4e.shuffle(app.selectedterms);\n      app.pointer = 0;\n      $(\".selfselect-container, #wordcards-start-button\").hide();\n      $(\"#wordcards-gameboard\").show();\n      $(\"#wordcards-time-counter\").text(\"00:00\");\n      app.timer = {\n        interval: setInterval(function() {\n          app.timer.update();\n        }, 1000),\n        count: 0,\n        update: function() {\n          app.timer.count++;\n          $(\"#wordcards-time-counter\").text(a4e.pretty_print_secs(app.timer.count));\n        }\n      }\n      app.next();\n    },\n    quit: function() {\n      clearInterval(app.timer.interval);\n      $(\"#wordcards-gameboard\").hide();\n      $(\"#wordcards-vocab-list, #wordcards-start-button\").show();\n    },\n\n    end: function() {\n      clearInterval(app.timer.interval);\n      $(\"#wordcards-gameboard, #wordcards-start-button\").hide();\n      $(\"#wordcards-results\").show();\n\n      //template data\n      var tdata = [];\n      tdata['nexturl'] = this.nexturl;\n      tdata['results'] = app.results;\n      tdata['total'] = app.selectedterms.length;\n      tdata['totalcorrect'] = a4e.calc_total_points(app.results);\n      var total_time = app.timer.count;\n      if (total_time == 0) {\n        tdata['prettytime'] = '00:00';\n      } else {\n        tdata['prettytime'] = a4e.pretty_print_secs(total_time);\n      }\n      templates.render('mod_wordcards/wordpreview_feedback', tdata).then(\n        function(html, js) {\n          $(\"#results-inner\").html(html);\n          // Add listeners for the \"Add to my words\" buttons.\n          require([\"mod_wordcards/mywords\"], function(mywords) {\n            mywords.initFromFeedbackPage();\n          });\n        }\n      );\n      // HACK - Post a 100% grade. There should be no grade\n      if (!app.isFreeMode) {\n        var termscount = app.terms.length;\n        Ajax.call([{\n          methodname: 'mod_wordcards_report_step_grade',\n          args: {\n            modid: app.modid,\n            correct: termscount\n          }\n        }]);\n      }\n    },\n\n    next: function() {\n      a4e.progress_dots(app.results, app.selectedterms);\n      var templateopts=app.selectedterms[app.pointer];\n      if(app.msoptions===app.termAtTop){\n        templateopts.termisheader=true;\n      }\n      templates.render('mod_wordcards/definition_as_header', templateopts).then(\n          function(html, js) {\n            $(\"#wordcards-question\").html(html);\n            //do text fit\n            var defheaders = $(\".definition-as-header\");\n            textFit(defheaders, {\n              multiLine: true,\n              maxFontSize: 50,\n              alignHoriz: true,\n              alignVert: true\n            });\n          }\n      );\n\n      $(\"#wordcards-input\").html(app.get_distractors());\n\n    },\n\n    check: function(correct, clicked) {\n      var points = 0;\n      if (correct == true) {\n        //createjs.Sound.play('correct');\n        points = 1;\n      } else {\n        //createjs.Sound.play('incorrect');\n      }\n      $(\".a4e-distractor\").css('pointer-events', 'none');\n      \n      var result = {\n        question: app.selectedterms[app.pointer]['definition'],\n        selected: $(clicked).text(),\n        correct: app.selectedterms[app.pointer]['term'],\n        points: points,\n        id: app.selectedterms[app.pointer]['id']\n      };\n      \n      app.results.push(result);\n\n      var background = correct == true ? 'a4e-correct' : 'a4e-incorrect';\n      $(clicked).addClass(background).append(\"<i style='color:\" + (correct ? 'green' : 'red') + \";margin-left:5px;' class='fa fa-\" + (correct ? 'check' : 'times') + \"'></i>\").parent().addClass('a4e-click-disabled');\n\n      if (!correct) {\n        $(\".a4e-distractor[data-correct='true']\").addClass('a4e-correct').append(\"<i style='color:green;margin-left:5px;' class='fa fa-check'></i>\");\n      }\n\n      //post results to server\n      if (correct) {\n        this.reportSuccess(app.selectedterms[app.pointer]['id']);\n      }\n\n      app.pointer++;\n      if (!correct) {\n        setTimeout(function() {\n          if (app.pointer < app.selectedterms.length) {\n            app.next();\n          } else {\n            app.end();\n          }\n        }, 1500)\n      } else {\n        setTimeout(function() {\n          if (app.pointer < app.selectedterms.length) {\n            app.next();\n          } else {\n            app.end();\n          }\n        }, 1000)\n      }\n    },\n\n    get_distractors: function() {\n      var distractors = app.terms.slice(0);\n      //find pointer in terms of current term in selected terms\n      var termspointer = app.terms.findIndex(function(t) {\n        return t.id === app.selectedterms[app.pointer].id;\n      });\n      var answer = app.terms[termspointer]['term'];\n      distractors.splice(termspointer, 1);\n      a4e.shuffle(distractors);\n      distractors = distractors.slice(0, 4);\n      distractors.push(app.terms[termspointer]);\n      a4e.shuffle(distractors);\n      var options = [];\n      $.each(distractors, function(i, o) {\n        var is_correct = o['term'] == answer;\n        var term_id = o['id'];\n        //depending on options  show option label as term or def\n        if(app.msoptions===app.termAtTop){\n          var label= o['definition'];\n        }else{\n          var label= o['term'];\n        }\n        options.push('<li data-id=\"' + term_id + '\" data-correct=\"' + is_correct.toString() + '\" class=\"list-group-item a4e-distractor a4e-noselect\">' + label + '</li>');\n      });\n      var code = '<ul class=\"list-group a4e-distractors\">' + options.join('') + '</ul>';\n      return code;\n    },\n\n    reportSuccess: function(termid) {\n      if (this.dryRun) {\n        return;\n      }\n\n      Ajax.call([{\n        methodname: 'mod_wordcards_report_successful_learnclaim',\n        args: {\n          termid: termid\n        }\n      }]);\n    }\n  };\n\n  return app;\n\n});"],"names":["define","$","Ajax","log","str","a4e","textFit","templates","notification","app","dryRun","termAtTop","strings","nexturl","init","props","theid","widgetid","modid","msoptions","isFreeMode","isfreemode","configcontrol","get","appdata","JSON","parse","value","remove","init_strings","currentUrl","URL","window","location","href","searchParams","delete","toString","debug","process","register_events","init_audio","token","region","owner","cloudpoodllurl","get_strings","done","s","i","nowordsselected","selectedwordstest","continue","on","e","preventDefault","total_time","timer","count","url","replace","reload","check","this","data","selectedcheckboxes","find","selectedterms","length","termid","learned","term","terms","filter","t","id","push","confirm","aterm","reportSuccess","theurl","start","list_selfselect","results","shuffle","pointer","hide","show","text","interval","setInterval","update","pretty_print_secs","next","quit","clearInterval","end","tdata","calc_total_points","render","then","html","js","require","mywords","initFromFeedbackPage","termscount","call","methodname","args","correct","progress_dots","templateopts","termisheader","defheaders","multiLine","maxFontSize","alignHoriz","alignVert","get_distractors","clicked","points","css","result","question","selected","background","addClass","append","parent","setTimeout","distractors","slice","termspointer","findIndex","answer","splice","options","each","o","is_correct","term_id","label","join"],"mappings":"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"}
{"version":3,"file":"dictation.min.js","sources":["../src/dictation.js"],"sourcesContent":["/**\r\n * Matching module.\r\n *\r\n * @package mod_wordcards\r\n * @author  Justin Hunt - poodll.com\r\n * * (based on Paul Raine's APPs 4 EFL)\r\n */\r\n\r\ndefine([\r\n  'jquery',\r\n  'core/ajax',\r\n  'core/log',\r\n  'mod_wordcards/a4e',\r\n  'mod_wordcards/keyboard',\r\n  'mod_wordcards/pollyhelper',\r\n  'core/templates'\r\n], function($, Ajax, log, a4e, keyboard, polly, templates) {\r\n\r\n  var app = {\r\n    dryRun: false,\r\n    audio: false,\r\n    ttslanguage: 'en-US',\r\n    distractors: [],\r\n    init: function(props) {\r\n\r\n      //pick up opts from html\r\n      var theid = '#' + props.widgetid;\r\n      this.dryRun = props.dryRun;\r\n      this.nexturl = props.nexturl;\r\n      this.modid = props.modid;\r\n      this.isFreeMode = props.isfreemode;\r\n      var configcontrol = $(theid).get(0);\r\n      if (configcontrol) {\r\n        var definitionsdata = JSON.parse(configcontrol.value);\r\n        $(theid).remove();\r\n      } else {\r\n        //if there is no config we might as well give up\r\n        log.debug('No config found on page. Giving up.');\r\n        return;\r\n      }\r\n\r\n      a4e.register_events();\r\n      a4e.init_audio(props.token,props.region,props.owner, props.cloudpoodllurl);\r\n\r\n      polly.init(props.token, props.region, props.owner, props.cloudpoodllurl);\r\n      app.ttslanguage = props.ttslanguage;\r\n      app.process(definitionsdata);\r\n\r\n\r\n\r\n      this.register_events();\r\n    },\r\n\r\n    register_events: function() {\r\n\r\n      // Get the audio element\r\n      var aplayer = $(\"#dictation_player\");\r\n\r\n      $('body').on('click', \"#wordcards-close-results\", function() {\r\n\r\n        var total_time = app.timer.count;\r\n        var url = app.nexturl.replace(/&amp;/g, '&') + \"&localscattertime=\" + total_time\r\n        window.location.replace(url);\r\n\r\n      });\r\n\r\n      $('body').on('click', \"#wordcards-try-again\", function() {\r\n        location.reload();\r\n      });\r\n\r\n      $(\"#listen-button\").click(function() {\r\n        if (app.audio) {\r\n          aplayer.attr('src', app.audio);\r\n          aplayer[0].play();\r\n        } else {\r\n          polly.fetch_polly_url(app.tts, 'text', app.ttsvoice);\r\n        }\r\n\r\n      });\r\n\r\n      //play what was returned in polly.fetch_polly_url\r\n      polly.onnewpollyurl = function(theurl) {\r\n        aplayer.attr('src', theurl);\r\n        aplayer[0].play();\r\n      };\r\n\r\n      $('body').on('click', '#wordcards-start-button', function() {\r\n        app.start();\r\n      });\r\n\r\n      $('body').on('click', '#wordcards-quit-button', function() {\r\n        app.quit();\r\n      });\r\n\r\n\r\n    },\r\n\r\n    process: function(json) {\r\n\r\n      app.terms = json.terms;\r\n      a4e.list_vocab(\"#vocab-list-inner\", app.terms);\r\n      app.distractors=app.terms_to_distractors(app.terms);\r\n\r\n    },\r\n    start: function() {\r\n      app.results = [];\r\n      a4e.shuffle(app.terms);\r\n      app.pointer = 0;\r\n      $(\"#wordcards-vocab-list, #wordcards-start-button\").hide();\r\n      $(\"#wordcards-gameboard, #wordcards-quit-button\").show();\r\n      $(\"#wordcards-time-counter\").text(\"00:00\");\r\n      app.timer = {\r\n        interval: setInterval(function() {\r\n          app.timer.update();\r\n        }, 1000),\r\n        count: 0,\r\n        update: function() {\r\n          app.timer.count++;\r\n          $(\"#wordcards-time-counter\").text(a4e.pretty_print_secs(app.timer.count));\r\n        }\r\n      };\r\n      app.next();\r\n    },\r\n    quit: function() {\r\n      keyboard.clear();\r\n      clearInterval(app.timer.interval);\r\n      $(\"#wordcards-gameboard, #wordcards-quit-button\").hide();\r\n      $(\"#wordcards-vocab-list, #wordcards-start-button\").show();\r\n    },\r\n\r\n    end: function() {\r\n      keyboard.clear();\r\n      clearInterval(app.timer.interval);\r\n      $(\"#wordcards-gameboard, #wordcards-quit-button, #wordcards-start-button\").hide();\r\n      $(\"#wordcards-results\").show();\r\n\r\n      //template data\r\n      var tdata = [];\r\n      tdata['nexturl'] = this.nexturl;\r\n      tdata['results'] = app.results;\r\n      tdata['total'] = app.terms.length;\r\n      tdata['totalcorrect'] = a4e.calc_total_points(app.results);\r\n      var total_time = app.timer.count;\r\n      if (total_time == 0) {\r\n        tdata['prettytime'] = '00:00';\r\n      } else {\r\n        tdata['prettytime'] = a4e.pretty_print_secs(total_time);\r\n      }\r\n      templates.render('mod_wordcards/feedback', tdata).then(\r\n        function(html, js) {\r\n          $(\"#results-inner\").html(html);\r\n          // Add listeners for the \"Add to my words\" buttons.\r\n          require([\"mod_wordcards/mywords\"], function(mywords) {\r\n            mywords.initFromFeedbackPage();\r\n          });\r\n        }\r\n      );\r\n\r\n      var data = {\r\n        results: app.results,\r\n        activity: \"dictation\"\r\n      };\r\n      console.log(data);\r\n\r\n      if (!app.isFreeMode) {\r\n        Ajax.call([{\r\n          methodname: 'mod_wordcards_report_step_grade',\r\n          args: {\r\n            modid: app.modid,\r\n            correct: tdata['totalcorrect']\r\n          }\r\n        }]);\r\n      }\r\n\r\n    },\r\n\r\n\r\n    next: function() {\r\n      \r\n      a4e.progress_dots(app.results, app.terms);\r\n\r\n      $(\"#wordcards-submitted\").html(\"\").removeClass(\"a4e-correct a4e-incorrect\");\r\n\r\n      var distractorscopy = app.distractors.slice(0);\r\n      keyboard.create(\"wordcards-input\", app.terms[app.pointer]['term'], app.pointer, distractorscopy, function(value) {\r\n        $(\"#wordcards-submitted\").html(app.terms[app.pointer]['term']);\r\n        keyboard.disable();\r\n        app.check(value);\r\n      });\r\n\r\n      app.tts = app.terms[app.pointer]['term'];\r\n      \r\n      if (app.terms[app.pointer]['ttsvoice']) {\r\n        app.ttsvoice = app.terms[app.pointer]['ttsvoice'];\r\n      } \r\n      \r\n      else {\r\n        app.ttsvoice = 'auto';\r\n      }\r\n      \r\n      if (app.terms[app.pointer]['audio']) {\r\n        app.audio = app.terms[app.pointer]['audio'];\r\n      } \r\n      \r\n      else {\r\n        app.audio = false;\r\n      }\r\n      \r\n      $(\"#listen-button\").trigger(\"click\");\r\n\r\n    },\r\n\r\n    check: function(selected) {\r\n      var correct = selected.toLowerCase().trim() == app.terms[app.pointer]['term'].toLowerCase().trim();\r\n      var points = 0;\r\n      if (correct == true) {\r\n        //createjs.Sound.play('correct');\r\n        $(\"#wordcards-submitted\").addClass(\"a4e-correct\");\r\n        points = 1;\r\n      } else {\r\n        $(\"#wordcards-submitted\").addClass(\"a4e-incorrect\");\r\n        //createjs.Sound.play('incorrect');\r\n      }\r\n\r\n      //post results to server\r\n      if (correct) {\r\n        this.reportSuccess(app.terms[app.pointer]['id']);\r\n      } else {\r\n        this.reportFailure(app.terms[app.pointer]['id'], 0);\r\n      }\r\n\r\n      var result = {\r\n        question: app.terms[app.pointer]['definition'],\r\n        selected: selected,\r\n        correct: app.terms[app.pointer]['term'],\r\n        points: points,\r\n        id: app.terms[app.pointer]['id']\r\n      };\r\n      \r\n      app.results.push(result);\r\n\r\n      if (app.pointer < app.terms.length - 1) {\r\n        app.pointer++;\r\n        setTimeout(function() {\r\n          app.next();\r\n        }, 1000)\r\n      } else {\r\n        app.end();\r\n      }\r\n\r\n\r\n    },\r\n\r\n    terms_to_distractors: function(terms){\r\n          var distractors=[];\r\n          for(var i=0;i<terms.length; i++){\r\n              var term = terms[i].term;\r\n              $.each(term.split(''),function(i,l){\r\n                  if(distractors.indexOf(l)==-1){\r\n                      distractors.push(l);\r\n                  }\r\n              });\r\n\r\n          }\r\n          return distractors;\r\n     },\r\n\r\n\r\n      reportFailure: function(term1id, term2id) {\r\n      if (this.dryRun) {\r\n        return;\r\n      }\r\n\r\n      Ajax.call([{\r\n        methodname: 'mod_wordcards_report_failed_association',\r\n        args: {\r\n          term1id: term1id,\r\n          term2id: term2id,\r\n          isfreemode: app.isFreeMode\r\n        }\r\n      }]);\r\n    },\r\n\r\n    reportSuccess: function(termid) {\r\n      if (this.dryRun) {\r\n        return;\r\n      }\r\n\r\n      Ajax.call([{\r\n        methodname: 'mod_wordcards_report_successful_association',\r\n        args: {\r\n          termid: termid,\r\n          isfreemode: app.isFreeMode\r\n        }\r\n      }]);\r\n    }\r\n  };\r\n\r\n  return app;\r\n\r\n});"],"names":["define","$","Ajax","log","a4e","keyboard","polly","templates","app","dryRun","audio","ttslanguage","distractors","init","props","theid","widgetid","nexturl","modid","isFreeMode","isfreemode","configcontrol","get","definitionsdata","JSON","parse","value","remove","register_events","init_audio","token","region","owner","cloudpoodllurl","process","debug","aplayer","on","total_time","timer","count","url","replace","window","location","reload","click","attr","play","fetch_polly_url","tts","ttsvoice","onnewpollyurl","theurl","start","quit","json","terms","list_vocab","terms_to_distractors","results","shuffle","pointer","hide","show","text","interval","setInterval","update","pretty_print_secs","next","clear","clearInterval","end","tdata","this","length","calc_total_points","render","then","html","js","require","mywords","initFromFeedbackPage","data","activity","console","call","methodname","args","correct","progress_dots","removeClass","distractorscopy","slice","create","disable","check","trigger","selected","toLowerCase","trim","points","addClass","reportSuccess","reportFailure","result","question","id","push","setTimeout","i","term","each","split","l","indexOf","term1id","term2id","termid"],"mappings":"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"}